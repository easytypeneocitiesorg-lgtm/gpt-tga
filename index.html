<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPT TGA Uploader with Chatbox</title>
<style>
body { font-family: sans-serif; margin: 20px; }
textarea { width: 100%; height: 200px; }
canvas { display: block; margin-top: 20px; border: 1px solid #000; }
#chatbox { border:1px solid #ccc; padding:10px; height:150px; overflow-y:auto; background:#f9f9f9; margin-top:20px; }
#chatbox div { margin-bottom:5px; }
</style>
</head>
<body>

<h1>AI → Canvas → TGA → Discord</h1>
<label>Prompt:</label>
<input type="text" id="prompt" style="width:100%" placeholder="Enter your prompt">
<button id="generate">Generate & Upload</button>

<h2>Paste TGA Text to View Image:</h2>
<textarea id="tgaText"></textarea>
<button id="view">View</button>

<canvas id="canvas"></canvas>

<h2>Progress Chatbox</h2>
<div id="chatbox"></div>

<script>
const CORS_PROXY = 'https://corsproxy.io/?';
const WEBHOOK_URL = 'https://discord.com/api/webhooks/1455672899192225989/9kdKQBwgdrCBlnxg4TLe57jftACcS7vaEM6AELseBrIPgmxTwVtZxiu5Qu_eeS-ex1Z1'; // remove <>

// === Chatbox logging ===
function log(msg) {
  const box = document.getElementById('chatbox');
  const div = document.createElement('div');
  div.textContent = msg;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// === Canvas → TGA ===
function canvasToTGA(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pixels = ctx.getImageData(0,0,w,h).data;
  const header = new Uint8Array(18);
  header[2] = 2; // uncompressed true-color
  header[12] = w & 0xFF;
  header[13] = (w >> 8) & 0xFF;
  header[14] = h & 0xFF;
  header[15] = (h >> 8) & 0xFF;
  header[16] = 24;

  const tga = new Uint8Array(18 + w*h*3);
  tga.set(header,0);
  let p=18;
  for(let y=h-1;y>=0;y--){
    for(let x=0;x<w;x++){
      const i=(y*w+x)*4;
      tga[p++]=pixels[i+2];
      tga[p++]=pixels[i+1];
      tga[p++]=pixels[i];
    }
  }
  return btoa(String.fromCharCode(...tga));
}

// === Generate & Upload TGA ===
document.getElementById('generate').onclick = async () => {
  const prompt = document.getElementById('prompt').value.trim();
  if(!prompt) return alert("Enter a prompt!");
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  try {
    log("Generating AI image...");

    // --- GPT Image API call (replace /api/generate with your endpoint) ---
    const res = await fetch('/api/generate', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({prompt})
    });
    const data = await res.json();
    if(!data.base64) throw new Error("No image returned from API");
    log("AI image received.");

    // Draw AI image onto canvas
    const img = new Image();
    img.src = 'data:image/png;base64,' + data.base64;
    img.onload = async () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
      log("Image drawn on canvas.");

      // Convert to TGA
      log("Converting to TGA...");
      const tgaText = canvasToTGA(canvas);
      log("Conversion complete.");

      const blob = new Blob([tgaText], {type:'text/plain'});
      const form = new FormData();
      form.append('file', blob, 'screenshot.txt');

      // Upload to Discord via CORS proxy
      try {
        log("Uploading TGA to Discord...");
        await fetch(CORS_PROXY + WEBHOOK_URL, {method:'POST', body:form});
        log("Upload successful!");
      } catch(err) {
        log("Upload failed, sending error message to Discord...");
        const errForm = new FormData();
        errForm.append('content', `Failed to send TGA. Prompt: "${prompt}"\nError: ${err.message}`);
        await fetch(CORS_PROXY + WEBHOOK_URL, {method:'POST', body:errForm});
        log("Error message sent.");
      }
    };

  } catch(err) {
    log("Error generating AI image, sending error message to Discord...");
    const errForm = new FormData();
    errForm.append('content', `Image generation failed. Prompt: "${prompt}"\nError: ${err.message}`);
    await fetch(CORS_PROXY + WEBHOOK_URL, {method:'POST', body:errForm});
    log("Error message sent.");
  }
};

// === Paste & View ===
document.getElementById('view').onclick = () => {
  const tgaText = document.getElementById('tgaText').value.trim();
  if(!tgaText) return;

  const binary = atob(tgaText);
  const tga = new Uint8Array(binary.length);
  for(let i=0;i<binary.length;i++) tga[i]=binary.charCodeAt(i);

  const w = tga[12]+(tga[13]<<8), h = tga[14]+(tga[15]<<8);
  const canvas = document.getElementById('canvas');
  canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  const imgData = ctx.createImageData(w,h);

  let p=18;
  for(let y=h-1;y>=0;y--){
    for(let x=0;x<w;x++){
      const i=(y*w+x)*4;
      imgData.data[i]=tga[p+2];
      imgData.data[i+1]=tga[p+1];
      imgData.data[i+2]=tga[p];
      imgData.data[i+3]=255;
      p+=3;
    }
  }
  ctx.putImageData(imgData,0,0);
  log("TGA loaded from pasted text.");
};
</script>

</body>
</html>

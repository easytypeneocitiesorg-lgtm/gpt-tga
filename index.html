<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPT TGA Uploader with Chatbox</title>
<style>
body { font-family: sans-serif; margin: 20px; }
textarea { width: 100%; height: 200px; }
canvas { display: block; margin-top: 20px; border: 1px solid #000; }
#chatbox { border:1px solid #ccc; padding:10px; height:150px; overflow-y:auto; background:#f9f9f9; margin-top:20px; }
#chatbox div { margin-bottom:5px; }
</style>
</head>
<body>

<h1>Image → Canvas → TGA → Discord</h1>

<label>Prompt (for log purposes):</label>
<input type="text" id="prompt" style="width:100%" placeholder="e.g. spacex rocket">

<button id="generate">Load & Upload Placeholder</button>

<h2>Paste TGA Text to View Image:</h2>
<textarea id="tgaText"></textarea>
<button id="view">View</button>

<canvas id="canvas"></canvas>

<h2>Progress Chatbox</h2>
<div id="chatbox"></div>

<script>
// === CONFIG ===
const CORS_PROXY = 'https://corsproxy.io/?'; 
const WEBHOOK_URL = '<YOUR_DISCORD_WEBHOOK_URL>'; // remove <>

// === Chatbox Logging ===
function log(msg) {
  const box = document.getElementById('chatbox');
  const div = document.createElement('div');
  div.textContent = msg;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

// === Canvas → TGA ===
function canvasToTGA(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pixels = ctx.getImageData(0, 0, w, h).data;

  const header = new Uint8Array(18);
  header[2] = 2; // uncompressed true-color
  header[12] = w & 0xFF;
  header[13] = (w >> 8) & 0xFF;
  header[14] = h & 0xFF;
  header[15] = (h >> 8) & 0xFF;
  header[16] = 24;

  const tga = new Uint8Array(18 + w*h*3);
  tga.set(header, 0);

  let p = 18;
  for (let y=h-1; y>=0; y--) {
    for (let x=0; x<w; x++) {
      const i = (y*w + x)*4;
      tga[p++] = pixels[i+2];
      tga[p++] = pixels[i+1];
      tga[p++] = pixels[i];
    }
  }
  return btoa(String.fromCharCode(...tga));
}

// === Load Placeholder Image into Canvas ===
async function loadPlaceholderImage(url, canvas) {
  log("Fetching placeholder image...");

  try {
    const response = await fetch(CORS_PROXY + url);
    const blob = await response.blob();
    const img = new Image();
    img.src = URL.createObjectURL(blob);

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    canvas.width = img.width;
    canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    log("Image loaded to canvas.");
    return true;
  } catch (err) {
    log("Failed to load image: " + err.message);
    return false;
  }
}

// === Generate & Upload TGA ===
document.getElementById('generate').onclick = async () => {
  const prompt = document.getElementById('prompt').value || "(no prompt)";
  const canvas = document.getElementById('canvas');

  // YOUR IMAGE URL
  const placeholderURL = "https://tse2.mm.bing.net/th/id/OIP.mH3ON19bzodDTup5AESiCgHaEK?rs=1&pid=ImgDetMain&o=7";

  // Load the placeholder
  const ok = await loadPlaceholderImage(placeholderURL, canvas);
  if (!ok) {
    const errorForm = new FormData();
    errorForm.append('content', `Failed to fetch placeholder image. Prompt: "${prompt}"`);
    await fetch(CORS_PROXY + WEBHOOK_URL, { method:'POST', body:errorForm });
    return;
  }

  log("Converting to TGA...");
  const tgaText = canvasToTGA(canvas);
  log("Conversion complete.");

  const blob = new Blob([tgaText], { type:'text/plain' });
  const form = new FormData();
  form.append('file', blob, 'screenshot.txt');

  log("Uploading TGA to Discord...");
  try {
    await fetch(CORS_PROXY + WEBHOOK_URL, { method:'POST', body: form });
    log("Upload successful!");
  } catch(err) {
    log("Upload failed, sending fallback message to Discord...");
    const errForm = new FormData();
    errForm.append('content', `Upload failed. Prompt: "${prompt}"\nError: ${err.message}`);
    await fetch(CORS_PROXY + WEBHOOK_URL, { method:'POST', body: errForm });
    log("Fallback sent.");
  }
};

// === Paste & View ===
document.getElementById('view').onclick = () => {
  const tgaText = document.getElementById('tgaText').value.trim();
  if (!tgaText) return;

  const binary = atob(tgaText);
  const tga = new Uint8Array(binary.length);
  for (let i=0; i<binary.length; i++) tga[i] = binary.charCodeAt(i);

  const w = tga[12] + (tga[13]<<8);
  const h = tga[14] + (tga[15]<<8);
  const canvas = document.getElementById('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  const imgData = ctx.createImageData(w, h);

  let p = 18;
  for (let y=h-1; y>=0; y--) {
    for (let x=0; x<w; x++) {
      const i=(y*w+x)*4;
      imgData.data[i]   = tga[p+2];
      imgData.data[i+1] = tga[p+1];
      imgData.data[i+2] = tga[p];
      imgData.data[i+3] = 255;
      p += 3;
    }
  }
  ctx.putImageData(imgData, 0, 0);
  log("TGA loaded from pasted text.");
};

</script>

</body>
</html>

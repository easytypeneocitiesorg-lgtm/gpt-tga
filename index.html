<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPT TGA Screenshot Uploader</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  textarea { width: 100%; height: 200px; }
  canvas { display: block; margin-top: 20px; }
</style>
</head>
<body>

<h1>GPT Image → TGA → Discord</h1>

<label>Prompt for AI Image:</label>
<input type="text" id="prompt" style="width:100%" placeholder="e.g. futuristic castle at sunset">
<button id="generate">Generate & Upload</button>

<h2>Paste TGA Text Here to View Image:</h2>
<textarea id="tgaText" placeholder="Paste screenshot.txt contents here"></textarea>
<button id="view">View Image</button>

<canvas id="canvas"></canvas>

<script>
async function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const chunkSize = 0x8000;
  for (let i = 0; i < bytes.length; i += chunkSize) {
    const chunk = bytes.subarray(i, i + chunkSize);
    binary += String.fromCharCode.apply(null, chunk);
  }
  return btoa(binary);
}

// Convert canvas to raw TGA
function canvasToTGA(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  const imageData = ctx.getImageData(0, 0, w, h);
  const pixels = imageData.data;

  const header = new Uint8Array(18);
  header[2] = 2; // uncompressed true-color
  header[12] = w & 0xFF;
  header[13] = (w >> 8) & 0xFF;
  header[14] = h & 0xFF;
  header[15] = (h >> 8) & 0xFF;
  header[16] = 24; // 24 bits per pixel

  const tga = new Uint8Array(18 + w * h * 3);
  tga.set(header, 0);

  let p = 18;
  for (let y = h - 1; y >= 0; y--) {
    for (let x = 0; x < w; x++) {
      const i = (y * w + x) * 4;
      tga[p++] = pixels[i + 2]; // B
      tga[p++] = pixels[i + 1]; // G
      tga[p++] = pixels[i];     // R
    }
  }

  return btoa(String.fromCharCode(...tga));
}

// Generate AI image + upload
document.getElementById('generate').onclick = async () => {
  const prompt = document.getElementById('prompt').value;
  if (!prompt) return alert("Enter a prompt!");

  // Call serverless API
  const res = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt })
  });
  const { base64 } = await res.json();

  // Draw AI image on canvas
  const img = new Image();
  img.src = 'data:image/png;base64,' + base64;
  img.onload = async () => {
    const canvas = document.getElementById('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);

    // Convert to TGA text
    const tgaText = canvasToTGA(canvas);

    // Upload to Discord webhook
    const webhookUrl = 'https://discord.com/api/webhooks/1455672899192225989/9kdKQBwgdrCBlnxg4TLe57jftACcS7vaEM6AELseBrIPgmxTwVtZxiu5Qu_eeS-ex1Z1'; // Replace with your webhook
    const form = new FormData();
    const blob = new Blob([tgaText], { type: 'text/plain' });
    form.append('file', blob, 'screenshot.txt');
    await fetch(webhookUrl, { method: 'POST', body: form });

    alert("TGA uploaded to Discord!");
  };
};

// Paste & view TGA
document.getElementById('view').onclick = () => {
  const tgaText = document.getElementById('tgaText').value;
  if (!tgaText) return;

  const binaryString = atob(tgaText);
  const tga = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) tga[i] = binaryString.charCodeAt(i);

  const w = tga[12] + (tga[13] << 8);
  const h = tga[14] + (tga[15] << 8);

  const canvas = document.getElementById('canvas');
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');
  const imgData = ctx.createImageData(w, h);

  let p = 18;
  for (let y = h - 1; y >= 0; y--) {
    for (let x = 0; x < w; x++) {
      const i = (y * w + x) * 4;
      imgData.data[i] = tga[p + 2];     // R
      imgData.data[i + 1] = tga[p + 1]; // G
      imgData.data[i + 2] = tga[p];     // B
      imgData.data[i + 3] = 255;        // A
      p += 3;
    }
  }
  ctx.putImageData(imgData, 0, 0);
};
</script>

</body>
</html>
